# パケットのネットワーク経由での流れ - 再カプセル化

## 概要

パケットがネットワークを流れる際、**再カプセル化（Re-encapsulation）**と呼ばれる重要なプロセスが発生します。これは、パケットがルーターを通過するたびに、イーサネットフレームのヘッダー情報が新しく書き換えられることを意味します。

## 主要な技術エンティティ

### ネットワーク構成要素

```
[Client]──[Switch]──[Router1]──[Router2]──[Server]
  10.0.0.1                                  10.1.1.1
    A          B      C    D    E      F
```

- **Client**: 送信元デバイス（IP: 10.0.0.1, MAC: A）
- **Switch**: レイヤー2スイッチ（MACアドレスを変更しない）
- **Router1**: 第1ルーター（インターフェース: B, C）
- **Router2**: 第2ルーター（インターフェース: D, E）  
- **Server**: 宛先デバイス（IP: 10.1.1.1, MAC: F）

### プロトコルレイヤーの役割

| レイヤー | プロトコル | 特徴 | アドレス変更 |
|---------|-----------|------|-------------|
| レイヤー2 | Ethernet | ポイント・ツー・ポイント通信 | ✓ 各ホップで変更 |
| レイヤー3 | IP | エンド・ツー・エンド通信 | ✗ 通常は変更なし |

## パケット流れの詳細解説

### ステップ1: クライアントから最初のルーターへ

```
┌─────────────────────────────────────────┐
│ Ethernet Header                         │
├─────────────────┬───────────────────────┤
│ Dest MAC: B     │ Source MAC: A         │
│ (Router1)       │ (Client)              │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ IP Header                               │
├─────────────────┬───────────────────────┤
│ Dest IP:        │ Source IP:            │
│ 10.1.1.1        │ 10.0.0.1              │
│ (Server)        │ (Client)              │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ Ping Data                               │
└─────────────────────────────────────────┘
```

**重要ポイント:**
- イーサネットヘッダーの宛先MACは最終的なサーバー（F）ではなく、次のホップであるルーター1（B）
- IPヘッダーは最終的な宛先（サーバー）を指している

### ステップ2: ルーター1での処理と転送

```
Router1の処理:
1. イーサネットフレームを受信
2. イーサネットヘッダーを除去
3. IPヘッダーを確認（宛先: 10.1.1.1）
4. ルーティングテーブルを参照
5. 新しいイーサネットフレームを作成
```

### ステップ3: ルーター1からルーター2へ

```
┌─────────────────────────────────────────┐
│ Ethernet Header (新しく作成)            │
├─────────────────┬───────────────────────┤
│ Dest MAC: D     │ Source MAC: C         │
│ (Router2)       │ (Router1)             │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ IP Header (変更なし)                    │
├─────────────────┬───────────────────────┤
│ Dest IP:        │ Source IP:            │
│ 10.1.1.1        │ 10.0.0.1              │
│ (Server)        │ (Client)              │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ Ping Data (変更なし)                    │
└─────────────────────────────────────────┘
```

### ステップ4: ルーター2からサーバーへ

```
┌─────────────────────────────────────────┐
│ Ethernet Header (再び新しく作成)        │
├─────────────────┬───────────────────────┤
│ Dest MAC: F     │ Source MAC: E         │
│ (Server)        │ (Router2)             │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ IP Header (変更なし)                    │
├─────────────────┬───────────────────────┤
│ Dest IP:        │ Source IP:            │
│ 10.1.1.1        │ 10.0.0.1              │
│ (Server)        │ (Client)              │
└─────────────────┴───────────────────────┘
┌─────────────────────────────────────────┐
│ Ping Data (変更なし)                    │
└─────────────────────────────────────────┘
```

## 再カプセル化の全体フロー図

```
Client Network    │    Router1    │    Router2    │ Server Network
                  │               │               │
[A]──────[B]      │      [C]──────[D]      [E]──────[F]
                  │               │               │
┌─────────────────┼───────────────┼───────────────┼──────────────┐
│ Hop 1           │ Hop 2         │ Hop 3         │              │
│ A→B (MAC)       │ C→D (MAC)     │ E→F (MAC)     │              │
│ 10.0.0.1→       │ 10.0.0.1→     │ 10.0.0.1→     │              │
│ 10.1.1.1 (IP)   │ 10.1.1.1 (IP) │ 10.1.1.1 (IP) │              │
└─────────────────┼───────────────┼───────────────┼──────────────┘
```

## キャプチャ地点による違い

### 各地点でのフレーム構造比較

| キャプチャ地点 | Source MAC | Dest MAC | Source IP | Dest IP |
|---------------|------------|----------|-----------|---------|
| Client-Switch間 | A | B | 10.0.0.1 | 10.1.1.1 |
| Router1-Router2間 | C | D | 10.0.0.1 | 10.1.1.1 |
| Router2-Server間 | E | F | 10.0.0.1 | 10.1.1.1 |

## トラブルシューティングでの応用

### 問題診断のポイント

1. **MACアドレスの確認**
   - 各ホップで適切なMACアドレスが使用されているか
   - ルーターが正しく次のホップを認識しているか

2. **IPアドレスの一貫性**
   - Source/Destination IPが全ホップで一致しているか
   - NATが使用されている場合の変更を確認

3. **キャプチャ地点の重要性**
   - 問題の切り分けには複数地点でのキャプチャが有効
   - どの地点でパケットが失われているかを特定

### 実際のトラブルシューティング例

**シナリオ**: クライアントからサーバーへのpingが失敗

**調査手順**:
1. クライアント側でキャプチャ → パケットが送信されているか確認
2. Router1の入力側でキャプチャ → パケットが到達しているか確認
3. Router1の出力側でキャプチャ → ルーティングが機能しているか確認
4. サーバー側でキャプチャ → パケットが最終的に到達しているか確認

**よくある問題**:
- **ARPテーブルの問題**: 正しいMACアドレスが解決されていない
- **ルーティング設定**: 適切な次のホップが設定されていない
- **VLAN設定**: 異なるVLAN間での通信ができていない

## まとめ

再カプセル化は、パケットがネットワークを移動する際の基本的なメカニズムです。重要な点は：

- **イーサネット**: 各ホップで新しいフレームが作成される
- **IP**: エンド・ツー・エンド通信のため、通常は変更されない
- **トラブルシューティング**: キャプチャ地点によって見えるMACアドレスが異なる

この理解により、Wiresharkでのパケット分析がより効果的になり、ネットワーク問題の根本原因を特定できるようになります。
